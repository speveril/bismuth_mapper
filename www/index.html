<html>
    <head>
        <title>BISMUTH MINECRAFT</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <link rel="stylesheet" type="text/css" href="mapper.css">
    </head>

    <body>
        <div class="load-helper"></div>
        <canvas id="map-surface"></canvas>
        <canvas id="overlay-surface"></canvas>
        <div class="input-catcher"></div>
    </body>

<script>

var tiles, markers;
var things_loaded = 0;
var things_to_load = 0;

var camera = [0,0,1];

function loadImages() {
    var $loadHelper = $('.load-helper');
    var marker_icons = ['icon.x.png','icon.square.png','icon.circle.png','icon.portal.png','icon.big_circle.png','icon.mine.png','icon.farm.png','icon.keep.png','icon.tower.png','icon.ruins.png'];

    for (var i = 0; i < marker_icons.length; i++) {
        var $img = $('<img>');
        var m = marker_icons[i].match(/\w+\.(\w+)\.\w+/);
        $img.attr('src', m[0]);
        $img.addClass("icon-" + m[1]);
        $loadHelper.append($img);

        things_to_load++;
        $img.on('error load', function() { things_loaded++; });
    }

    for (var i = 0; i < tiles.length; i++) {
        var $img = $('<img>');
        $img.attr('src', tiles[i].src + '?rnd=' + Math.random());
        $loadHelper.append($img);
        tiles[i].img = $img[0];

        things_to_load++;
        $img.on('load', function() { things_loaded++; });
        $img.on('error', function(tile) { tile.img = null; things_loaded++; }.bind(this, tiles[i]));
    }
}

function resizeCanvases() {
    $('canvas')
        .attr('width', $(window).width())
        .attr('height', $(window).height())
    ;
    redrawMap();
}

function redrawMap() {
    var $mapCanvas = $('#map-surface');
    var ctx = $mapCanvas[0].getContext("2d");
    ctx.imageSmoothingEnabled = false;
    ctx.mozImageSmoothingEnabled = false;
    ctx.oImageSmoothingEnabled = false;
    ctx.webkitImageSmoothingEnabled = false;

    var $mapCanvas = $('#overlay-surface');
    var ctxO = $mapCanvas[0].getContext("2d");
    ctxO.imageSmoothingEnabled = false;
    ctxO.mozImageSmoothingEnabled = false;
    ctxO.oImageSmoothingEnabled = false;
    ctxO.webkitImageSmoothingEnabled = false;

    ctxO.font = "10pt Calibri";
    ctxO.fillStyle = '#ffffff';
    ctxO.strokeStyle = '#000000';
    ctxO.lineWidth = 4;

    var w = $mapCanvas.attr('width');
    var h = $mapCanvas.attr('height');

    ctx.fillRect(0, 0, w, h);
    ctxO.clearRect(0, 0, w, h);

    for (var i = 0; i < tiles.length; i++) {
        var tile = tiles[i]
        var x = (tile.x - camera[0]) * camera[2];
        var y = (tile.y - camera[1]) * camera[2];
        var sz = 512 * camera[2];

        if (x + sz >= 0 && x < w && y + sz >= 0 && y < h && tile.img) {
            ctx.drawImage(tile.img, x, y, sz, sz);
            // console.log(markers[tile.region]);
        }
    }

    for (var i = 0; i < tiles.length; i++) {
        var tile = tiles[i]
        var x = (tile.x - camera[0]) * camera[2];
        var y = (tile.y - camera[1]) * camera[2];
        var sz = 512 * camera[2];

        if (x + sz >= 0 && x < w && y + sz >= 0 && y < h && tile.img) {
            for (var j = 0; j < markers[tile.region].length; j++) {
                var mark = markers[tile.region][j];
                var mx = (mark.x - camera[0] + 0.5) * camera[2];
                var my = (mark.z - camera[1] + 0.5) * camera[2];
                var text = mark.label.replace(/\\u0027/g, "'");
                var textw = ctxO.measureText(text);

                ctxO.drawImage($('.icon-' + mark.type)[0], mx - 5, my - 5);
                ctxO.strokeText(text, mx - textw.width / 2, my - 8);
                ctxO.fillText(text, mx - textw.width / 2, my - 9);
            }
        }
    }

    document.cookie = JSON.stringify(camera);
}

function waitForLoad(cb) {
    if (things_loaded >= things_to_load) {
        cb();
    } else {
        setTimeout(waitForLoad.bind(this, cb), 25);
    }
}

function setupInput() {
    var dragging = false;
    var lastMousePos = [];
    var zoomSpeed = 0.5;

    $('.input-catcher').on('mousedown', function(evt) {
        dragging = true;
        $('.input-catcher').addClass('dragging');
    });
    $('.input-catcher').on('mouseup', function(evt) {
        dragging = false;
        $('.input-catcher').removeClass('dragging');
    });
    $('.input-catcher').on('mousemove', function(evt) {
        if (dragging) {
            var dx = evt.pageX - lastMousePos[0];
            var dy = evt.pageY - lastMousePos[1];
            camera[0] -= dx / camera[2];
            camera[1] -= dy / camera[2];
            redrawMap();
        }
        lastMousePos = [evt.pageX, evt.pageY];
    });
    $('.input-catcher').on('mousewheel', function(evt) {
        var wX = camera[0] + lastMousePos[0] / camera[2];
        var wY = camera[1] + lastMousePos[1] / camera[2];

        if (evt.originalEvent.wheelDelta > 0 && camera[2] < 16) {
            camera[2] /= zoomSpeed;
        } else if (evt.originalEvent.wheelDelta < 0 && camera[2] > 0.1) {
            camera[2] *= zoomSpeed;
        }

        camera[0] = wX - lastMousePos[0] / camera[2];
        camera[1] = wY - lastMousePos[1] / camera[2];
        redrawMap();
    });
}

// --- loading stuff ---

function loadingError(xhr, type, error) {
    console.log("Loading error:", type, error);
}

function startLoading() {
    $.ajax({dataType:'json', url:'tile/tiles.json?rnd=' + Math.random(), success: loadedTileJSON, error: loadingError});
}

function loadedTileJSON(data) {
    tiles = [];
    for (k in data) {
        if (data.hasOwnProperty(k)) {
            data[k].region = k;
            tiles.push(data[k]);
        }
    }
    loadImages();
    $.ajax({dataType:'json', url:'tile/markers.json?rnd=' + Math.random(), success: loadedMarkerJSON, error: loadingError});
}

function loadedMarkerJSON(data) {
    markers = data;
    console.log(markers);
    waitForLoad(loadedImages);
}

function loadedImages() {
    if (document.cookie) {
        camera = JSON.parse(document.cookie);
    }

    if (!document.cookie || camera.length != 3 || camera[2] < 0.1 || camera[2] > 16) {
        camera = [-$('canvas').width() / 2, -$('canvas').height() / 2, 1];
    }

    setupInput();

    $(window).on('resize',resizeCanvases);
    resizeCanvases();
}


// DO IT
$(startLoading);
// OKAY YOU DID IT

</script>

</html>
